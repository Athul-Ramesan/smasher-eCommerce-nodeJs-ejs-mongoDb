<%-include ('../layouts/adminHeader') %>
    <%-include ('../partials/adminSidebar') %>
        <!-- Button trigger modal -->

<!-- add product offer Modal -->
<div class="modal fade" id="productOfferModal" tabindex="-1" aria-labelledby="productOfferModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-center text-italic fw-bold id=" productOfferModalLabel">Add New
                    Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addProductOffer">
                <div class="modal-body">

                    <div class="card o-hidden border-0 shadow-lg my-5">
                        <div class="card-body p-0">
                            <!-- Nested Row within Card Body -->
                            <div class="row">
                                <div class="col-lg-12">

                                    <div class="p-5">

                                        <div class="row">
                                            <div class="col-lg-12">
                                                <label for="category">Category:</label>
                                                <select class="form-select bg-light" id="product"
                                                    name="productId" required>
                                                    <option value="" selected disabled>Select a Product</option>
                                                    <% products.forEach((product)=>{ %>
                                                        <option value="<%=product._id%>">
                                                            <%=product.name%>
                                                        </option>
                                                        <%}) %>
                                                </select>
                                                <div class="form-group">
                                                    <div class="mb-2 ml-3 cl2"><span>Discount Percentage</span>
                                                    </div>
                                                    <input type="number" class="form-control form-control-user"
                                                        id="discountPercentageProduct"
                                                        placeholder="Enter Discount Percentage"
                                                        name="discountPercentage">
                                                </div>
                                                <div class="form-group">
                                                    <div class="mb-2 ml-3 cl2"><span>Expiry Date</span>
                                                    </div>
                                                    <input type="date" class="form-control form-control-user"
                                                        id="exampleFirstName"
                                                        placeholder="Enter Discount Percentage" name="expiryDate">
                                                </div>
                                                <!-- <div class="form-group row">
                                                    <div class="col-sm-6 mb-2 mb-sm-0">
                                                        <div class="mb-2 ml-3 cl2"><span>Price</span></div>
                                                        <input type="text" class="form-control form-control-user"
                                                            id="exampleLastName altText" placeholder="Enter Offer price"
                                                            name="price">
                                                    </div>
                                                </div> -->
                                            </div>

                                        </div>
                                        <hr>
                                        <!-- <button type="submit" class="btn bg1 text-white hov-btn1 btn-user btn-block">
                                            Save Changes
                                        </button> -->

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-outline-info bg1 text-dark hov-btn1  btn-block">Add
                        Offer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--add product offer Modal ends-->


<!-- product offer table -->
<div id="content-wrapper" class="d-flex flex-column mt-5">
    <!-- Main Content -->

    <div id="content">
        <!-- Begin Page Content -->
        <div class="container-fluid">
            <!-- DataTales Example -->
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold cl1">Product Offers</h6>
                    <div>
                        <a data-bs-toggle="modal" data-bs-target="#productOfferModal" role="button">
                            <i class="fa fa-plus-circle cl1"></i><span class="pl-2">Add new offer </span>
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable3" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Discount Percentage</th>
                                    <th>Expires At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% productOffers?.forEach((offer)=>{%>
                                    <tr>
                                        <td>
                                            <%= offer.productId?.name %>
                                        </td>

                                        <td>
                                            <%= offer.discountPercentage %>
                                        </td>
                                        <td>
                                            <%= offer.expiryDate %>
                                        </td>
                                        <td>
                                            <a href="/admin/removeProductOffer/<%=offer._id%>"
                                                class="pl-2 remove-button">Remove</a>
                                        </td>
                                    </tr>
                                    <% })%>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.container-fluid -->
    </div>
    <!-- End of Main Content -->
</div>
<!-- product offer table ends -->


        <!--add category offer Modal -->
        <div class="modal fade" id="categoryOfferModal" tabindex="-1" aria-labelledby="categoryOfferModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="categoryOfferModalLabel">Category Offer</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="addCategoryOffer">
                        <div class="modal-body">
                            <div class="card o-hidden border-0 shadow-lg my-5">
                                <div class="card-body p-0">
                                    <!-- Nested Row within Card Body -->
                                    <div class="row">
                                        <div class="col-lg-12">

                                            <div class="p-5">

                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <div class="mb-3">
                                                            <label for="category">Category:</label>
                                                            <select class="form-select bg-light" id="category"
                                                                name="categoryId" required>
                                                                <option value="" selected disabled>Select a category
                                                                </option>
                                                                <% categories.forEach((category)=>{ %>
                                                                    <option value="<%=category._id%>">
                                                                        <%=category.name%>
                                                                    </option>
                                                                    <%}) %>
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <div class="mb-2 ml-3 cl2"><span>Discount%</span></div>
                                                            <input type="number" class="form-control form-control-user"
                                                                id="discountPercentageCategory"
                                                                placeholder="Enter Discount Percentage"
                                                                name="discountPercentage">
                                                        </div>
                                                        <div class="form-group">
                                                            <div class="mb-2 ml-3 cl2"><span>Expiry Date</span>
                                                            </div>
                                                            <input type="date" class="form-control form-control-user"
                                                                id="expiry-date" placeholder="Enter Discount Percentage"
                                                                name="expiryDate">
                                                        </div>
                                                        <!-- <div class="form-group row">
                                                            <div class="col-sm-6 mb-2 mb-sm-0">
                                                                <div class="mb-2 ml-3 cl2"><span>Price</span></div>
                                                                <input type="text" class="form-control form-control-user"
                                                                    id="exampleLastName altText" placeholder="Enter Offer price"
                                                                    name="price">
                                                            </div>
                                                            <div class="col-sm-6">
                                                                <div class="mb-2 ml-3 cl2"><span>Image</span></div>
                                                                <input type="file" class="form-control form-control-user"
                                                                    id="fileupload" placeholder="Upload Image"
                                                                    name="image" required>
                                                            </div>
                                                        </div> -->
                                                    </div>

                                                </div>
                                                <hr>


                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>


                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-outline-info bg1 text-dark hov-btn1  btn-block">Add
                                Offer</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!--add category offer Modal ends-->

        <!-- category offer table  -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->

            <div id="content">
                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- DataTales Example -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                            <h6 class="m-0 font-weight-bold cl1">Category Offers</h6>
                            <div>
                                <a data-bs-toggle="modal" data-bs-target="#categoryOfferModal" role="button">
                                    <i class="fa fa-plus-circle cl1"></i><span class="pl-2">Add new offer</span>
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="dataTable3" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Discount Percentage</th>
                                            <th>Expires At</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% categoryOffers?.forEach((offer)=>{%>
                                            <tr>
                                                <td>

                                                    <%= offer.categoryId?.name %>
                                                </td>

                                                <td>
                                                    <%= offer.discountPercentage %>
                                                </td>
                                                <td>
                                                    <%= offer.expiryDate %>
                                                </td>
                                                <td>
                                                    <a href="/admin/removeCategoryOffer/<%=offer._id%>"
                                                        class="pl-2 remove-button">Remove</a>
                                                </td>
                                            </tr>
                                            <% })%>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->
        </div>

        <!-- category offer table ends -->

        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <script>

            document.addEventListener('DOMContentLoaded', () => {
                

                // async function getProductData (){
                //     document.getElementById('productOfferModalLabel').addEventListener('click', async (e) => {
                //     try {
                //         const response = await fetch('/admin/getProductsData')
                //         if (!response.ok) {
                //             throw new Error('Network response error')
                //         }
                //         const data = await response.json()
                //         console.log(data);
                //         return data
                //     } catch (error) {
                //         console.log(error);  
                //     }


                // })
                // }
                function validateDiscountPercentage(input) {
                    console.log('inside % vakl');
                    const value = input.value.trim();
                    const isPositiveInteger = /^\d+$/.test(value) && parseInt(value) > 0 && parseInt(value)<100;
                    return isPositiveInteger;
                }
                function validateDate(input) {
                    const currentDate = new Date();
                    const selectedDate = new Date(input.value)

                    if (currentDate > selectedDate) {
                        return false
                    } else {
                        return true
                    }
                }

                document.getElementById('addProductOffer').addEventListener('submit', (e) => {
                    e.preventDefault()
                    console.log('hiiiiii');

                    const discountPercentageInput = document.getElementById('discountPercentageProduct');


                    if (!validateDiscountPercentage(discountPercentageInput)) {

                        Toastify({

                            text: 'Please enter a valid Discount Percentage.',

                            duration: 3000,
                            position: "center",
                            className: "info",
                            style: {
                                background: "red",
                            }

                        }).showToast()


                        return;
                    }

                    const data = $('#addProductOffer').serialize();
                    $.ajax({
                        url: '/admin/addProductOffer',
                        method: 'post',
                        data: data,
                        success: (response) => {
                            console.log(response)
                            if (response.success) {
                                console.log(response)
                                $('#productOfferModal').modal('hide');

                                Toastify({

                                    text: response.message,

                                    duration: 3000,
                                    position: "center",
                                    className: "info",
                                    style: {
                                        background: "linear-gradient(to right,#00e600, #96c93d)",
                                    }

                                }).showToast()
                                setTimeout(() => {
                                    window.location.reload()
                                }, 3000)


                            } else {
                                $('#productOfferModal').modal('hide');

                                Toastify({

                                    text: response.message,

                                    duration: 3000,
                                    position: "center",
                                    className: "info",
                                    style: {
                                        background: "red",
                                    }

                                }).showToast()
                                setTimeout(() => {
                                    window.location.reload()
                                }, 3000)
                            }
                        }
                    })
                })


                document.getElementById('addCategoryOffer').addEventListener('submit', (e) => {
                    e.preventDefault()
                    console.log('hiiiiii');

                    const discountPercentageInput = document.getElementById('discountPercentageCategory');
                    const dateInput = document.getElementById('expiry-date')

                    if (!validateDiscountPercentage(discountPercentageInput)) {

                        Toastify({

                            text: 'Please enter a valid positive integer for the Discount Percentage.',

                            duration: 3000,
                            position: "center",
                            className: "info",
                            style: {
                                background: "red",
                            }

                        }).showToast()


                        return;
                    }
                    // if (!validateDate(dateInput)) {
                    //     Toastify({

                    //         text: 'Please select a future date.',

                    //         duration: 3000,
                    //         position: "center",
                    //         className: "info",
                    //         style: {
                    //             background: "red",
                    //         }

                    //     }).showToast()


                    //     return;
                    // }
                    const data = $('#addCategoryOffer').serialize();
                    $.ajax({
                        url: '/admin/addCategoryOffer',
                        method: 'post',
                        data: data,
                        success: (response) => {
                            console.log(response)
                            if (response.success) {
                                console.log(response)
                                $('#categoryOfferModal').modal('hide');
                                Toastify({

                                    text: response.message,

                                    duration: 3000,
                                    position: "center",
                                    className: "info",
                                    style: {
                                        background: "linear-gradient(to right,#00e600, #96c93d)",
                                    }

                                }).showToast()
                                setTimeout(() => {
                                    window.location.reload()
                                }, 3000)
                            } else {
                                $('#productOfferModal').modal('hide');

                                Toastify({

                                    text: response.message,

                                    duration: 3000,
                                    position: "center",
                                    className: "info",
                                    style: {
                                        background: "red",
                                    }

                                }).showToast()
                                setTimeout(() => {
                                    window.location.reload()
                                }, 3000)
                            }
                        }
                    })
                })

                const removeButtons = document.querySelectorAll('.remove-button')
                removeButtons.forEach((button) => {
                    button.addEventListener('click', (event) => {
                        event.preventDefault()

                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, delete it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = button.href
                            }

                        })
                    })
                })

            })

        </script>
        <%-include ('../layouts/adminFooter') %>