<%- include ('../layouts/header') %>
    <%- include ('../partials/userHeader') %>

        <style>
            .checkout .form-control {
                border-radius: 0px !important;
            }

            .checkout .form-control:focus {
                border: 1px solid #000 !important;
                box-shadow: none !important;
            }

            .checkout .nav-link {
                border: 1px solid #000;
                border-radius: 0px;
                margin-bottom: 8px;
            }

            .checkout .tab-content {
                padding-right: 10px;
            }
        </style>

        <div class="py-3 py-md-4 checkout">
            <div class="container">
                <div class="d-flex justify-content-between">
                    <h4>Shipping Addresses</h4>
                    <a data-bs-toggle="modal" data-bs-target="#addAddressModal" class="btn-lg btn  btn-outline-success"
                        role="button"><i class="fa-sharp fa-solid fa-plus"></i>Add new address</a>
                </div>

                <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title text-center text-italic fw-bold" id=" addAddressModalLabel">Add
                                    New
                                    Addess</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <form id="addAddress">
                                <div class="container">
                                    <div class="row">
                                        <div class="col-md-12 m-2">

                                            <input type="text" id="name" name="name" class="form-control"
                                                placeholder="Name" />
                                        </div>
                                        <div class="col-md-12 m-2">

                                            <input type="number" id="mobile" name="mobile" class="form-control"
                                                placeholder="Phone Number" />
                                        </div>

                                        <div class="col-md-12 m-2">

                                            <input type="number" id="pincode" name="pincode" class="form-control"
                                                placeholder="Pin-code" />
                                        </div>
                                        <div class="col-md-12 m-2">

                                            <input type="text" id="locality" name="locality" class="form-control"
                                                placeholder="Locality" />
                                        </div>
                                        <div class="col-md-12 m-2">

                                            <input name="houseName" id="houseName" placeholder="House name"
                                                class="form-control">
                                        </div>
                                        <div class="col-md-12 m-2">

                                            <input type="text" id="district" name="district" class="form-control"
                                                placeholder="District/Twon?City" />
                                        </div>
                                        <div class="col-md-12 m-2">

                                            <input type="text" id="state" name="state" class="form-control"
                                                placeholder="Enter state" />
                                        </div>
                                        <div class="col-md-12 m-2 ">
                                            <button type="submit" class="btn m-3 btn-outline-primary">Add
                                                Address</button>
                                        </div>

                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <hr>
                <!-- add address modal ends -->

                <!-- edit address modal starts -->
                <%addresses.address.forEach((address)=>{%>
                    <div class="modal fade" id="editAddressModal<%=address._id%>" tabindex="-1"
                        aria-labelledby="editAddressModalLabel<%=address._id%>" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title text-center text-italic fw-bold"
                                        id=" editAddressModalLabel<%=address._id%>"> Edit address</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Close"></button>
                                </div>
                                <form id="editAddress<%=address._id%>">
                                    <div class="container">
                                        <div class="row">
                                            <div class="col-md-12 m-2">

                                                <input type="text" id="name" name="name" class="form-control"
                                                    placeholder="Name" value="<%=address.name%>" />
                                            </div>
                                            <div class="col-md-12 m-2">

                                                <input type="number" id="mobile" name="mobile" class="form-control"
                                                    placeholder="Phone Number" value="<%=address.mobile%>"" />
                                            </div>
    
                                            <div class=" col-md-12 m-2">

                                                <input type="number" id="pincode" name="pincode"
                                                    class="form-control" placeholder="Pin-code"
                                                    value="<%=address.pincode%>"" />
                                            </div>
                                            <div class=" col-md-12 m-2">

                                                <input type="text" id="locality" name="locality"
                                                    class="form-control" placeholder="Locality"
                                                    value="<%=address.locality%>" />
                                            </div>
                                            <div class="col-md-12 m-2">

                                                <input name="houseName" id="houseName" placeholder="House name"
                                                    class="form-control" value="<%=address.houseName%>">
                                            </div>
                                            <div class="col-md-12 m-2">

                                                <input type="text" id="district" name="district"
                                                    class="form-control" placeholder="District/Twon?City"
                                                    value="<%=address.district%>" />
                                            </div>
                                            <div class="col-md-12 m-2">

                                                <input type="text" id="state" name="state" class="form-control"
                                                    placeholder="Enter state" value="<%=address.state%>" />
                                            </div>
                                            <div class="col-md-12 m-2 ">
                                                <button data-order-id="" class="btn m-3 btn-outline-success"
                                                    >Save
                                                    changes</button>
                                            </div>

                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <%})%>

                        <!-- edit address modal ends -->

                        <div class="row">
                            <%if ( addresses){%>


                                <%addresses.address.forEach((address,index)=>{ %>


                                    <div class="container">
                                        <div class="row">
                                            <div class="col-md-12 g-2 shadow">
                                                <div class="card">
                                                    <!-- Card Header -->
                                                    <div class=" d-flex justify-content-between align-items-center">
                                                        <h5 class="card-title text-muted m-2 ps-2">Address No.<%=index+1
                                                                %>
                                                        </h5>



                                                        <!-- Dropdown menu -->
                                                        <div class="dropdown">
                                                            <button class="btn btn-link" type="button"
                                                                id="dropdownMenuButton" data-bs-toggle="dropdown"
                                                                aria-haspopup="true" aria-expanded="false">
                                                                <i class="fas fa-ellipsis-h"></i>
                                                            </button>
                                                            <div class="dropdown-menu"
                                                                aria-labelledby="dropdownMenuButton">
                                                                <a class="dropdown-item"
                                                                    data-bs-target="#editAddressModal<%=address._id%>"
                                                                    data-bs-toggle="modal">Edit</a>
                                                                <a class="dropdown-item remove-button"
                                                                    href="/deleteAddress/<%=address._id%>">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <!-- Card content -->
                                                    <hr>
                                                    <div class="card-body">
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold text-uppercase">
                                                                <%=address.name %>
                                                            </span>
                                                        </div>
                                                        <span class="m-1 font-weight-bold text-uppercase">
                                                            <%=address.mobile %>
                                                        </span>
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold text-uppercase">
                                                                <%=address.houseName %>
                                                            </span>
                                                            <span class="m-1 font-weight-bold text-uppercase">
                                                                <%=address.locality %>
                                                            </span>
                                                            <span class="m-1 font-weight-bold text-uppercase">
                                                                <%=address.pincode %>
                                                            </span>
                                                        </div>
                                                        <div class="d-flex">
                                                            <span class="m-1 font-weight-bold text-uppercase">
                                                                <%=address.district %>
                                                            </span>
                                                            <span class="m-1 font-weight-bold text-uppercase">
                                                                <%=address.state %>
                                                            </span>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                    </div>
                                    <% }) %>

                                        <%}%>
                        </div>
            </div>
        </div>
        <% addresses.address.forEach((address)=> { %>
            <script>

                document.addEventListener("DOMContentLoaded", () => {

                    function editAddress(id) {
                        const form = document.getElementById(`editAddress${id}`);
                        console.log(id);
                        if (form) {
                            console.log('inside editAddress');
                            form.addEventListener('submit', function (event) {
                                event.preventDefault();

                                // Retrieve form data and make a fetch request to update the address
                                const formData = new FormData(form);
                                const requestData = Object.fromEntries(formData);

                                console.log('Request Data:', requestData);

                                const requestOptions = {
                                    method: "PUT",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify(requestData),
                                };

                                fetch(`/address?addressId=${id}`, requestOptions)
                                    .then((response) => {
                                        console.log('Response:', response);
                                        if (response.status === 422) {
                                            return response.json();
                                        } else if (response.status === 201) {
                                            console.log(response.result,'REUASLKDHGGASDFH');
                                            Toastify({
                                                text: 'Address updated successfully',
                                                duration: 3000,
                                                position: "center",
                                                className: "info",
                                                style: {
                                                    background: "green",
                                                }
                                            }).showToast();
                                            setTimeout(()=>{
                                                window.location.reload();
                                            },3000)
                                            
                                        }
                                    })
                                    .then((data) => {
                                        if (data && data.errors) {
                                            console.log('Validation Errors:', data.errors);
                                            data.errors.forEach((errorMessage) => {
                                                Toastify({
                                                    text: errorMessage,
                                                    duration: 3000,
                                                    position: "bottom-center",
                                                    className: "info",
                                                    style: {
                                                        background: "red",
                                                    }
                                                }).showToast();
                                                
                                            });
                                        }
                                    })
                                    .catch((error) => {
                                        console.error('Error:', error);
                                    });
                            });
                        }
                    }
                    editAddress('<%= address._id %>');
                })
            </script>
            <% }); %>
                <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
                <script>

                    document.addEventListener("DOMContentLoaded", () => {

                        document.getElementById('addAddress').addEventListener('submit', (e) => {
                            e.preventDefault();
                            const name = document.getElementById('name').value
                            const mobile = document.getElementById('mobile').value
                            const pincode = document.getElementById('pincode').value
                            const houseName = document.getElementById('houseName').value
                            const state = document.getElementById('state').value
                            const district = document.getElementById('district').value
                            const locality = document.getElementById('locality').value




                            const requestOptions = {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    name: name,
                                    houseName: houseName,
                                    state: state,
                                    mobile: mobile,
                                    pincode: pincode,
                                    district: district,
                                    locality: locality
                                }),
                            };


                            fetch("/addAddress", requestOptions)
                                .then((response) => {
                                    console.log(response.error, 'responseeeee');
                                    if (response.status === 422) {
                                        return response.json();

                                    } else if (response.status === 201) {
                                        Toastify({

                                            text: 'Address added successfully',

                                            duration: 3000,
                                            position: "center",
                                            className: "info",
                                            style: {
                                                background: "success",
                                            }

                                        }).showToast()
                                        setTimeout(()=>{
                                                window.location.reload();
                                            },3000)
                                    }
                                })
                                .then((data) => {
                                    if (data && data.errors) {
                                        console.log(data);
                                        data.errors.forEach((errorMessage) => {
                                            Toastify({

                                                text: errorMessage,

                                                duration: 3000,
                                                position: "bottom-center",
                                                className: "info",
                                                style: {
                                                    background: "red",
                                                }

                                            }).showToast()

                                        });
                                    }
                                })
                                .catch((error) => {
                                    console.log(error, "error");
                                });
                        })




                        // function editAddress(id) {
                        //     document.getElementById(`editAddress${id}`).addEventListener('submit', (e) => {
                        //         e.preventDefault();
                        //         console.log('iside edit addres');
                        //         const name = document.getElementById('name-edit').value
                        //         const mobile = document.getElementById('mobile-edit').value
                        //         const pincode = document.getElementById('pincode-edit').value
                        //         const houseName = document.getElementById('houseName-edit').value
                        //         const state = document.getElementById('state-edit').value
                        //         const district = document.getElementById('district-edit').value
                        //         const locality = document.getElementById('locality-edit').value




                        //         const requestOptions = {
                        //             method: "PUT",
                        //             headers: { "Content-Type": "application/json" },
                        //             body: JSON.stringify({
                        //                 addressId: id,
                        //                 name: name,
                        //                 houseName: houseName,
                        //                 state: state,
                        //                 mobile: mobile,
                        //                 pincode: pincode,
                        //                 district: district,
                        //                 locality: locality
                        //             }),
                        //         };


                        //         fetch("/address", requestOptions)
                        //             .then((response) => {
                        //                 console.log(response.error, 'responseeeee');
                        //                 if (response.status === 422) {
                        //                     return response.json();

                        //                 } else if (response.status === 201) {
                        //                     Toastify({

                        //                         text: response.message,

                        //                         duration: 3000,
                        //                         position: "center",
                        //                         className: "info",
                        //                         style: {
                        //                             background: "success",
                        //                         }

                        //                     }).showToast()
                        //                     window.location.reload();
                        //                 }
                        //             })
                        //             .then((data) => {
                        //                 if (data && data.errors) {
                        //                     console.log(data);
                        //                     data.errors.forEach((errorMessage) => {
                        //                         Toastify({

                        //                             text: errorMessage,

                        //                             duration: 3000,
                        //                             position: "bottom-center",
                        //                             className: "info",
                        //                             style: {
                        //                                 background: "red",
                        //                             }

                        //                         }).showToast()

                        //                     });
                        //                 }
                        //             })
                        //             .catch((error) => {
                        //                 console.log(error, "error");
                        //             });
                        //     })
                        // }


                        const removeButtons = document.querySelectorAll('.remove-button')
                        removeButtons.forEach((button) => {
                            button.addEventListener('click', (event) => {
                                event.preventDefault()

                                Swal.fire({
                                    title: 'Are you sure?',
                                    text: "You won't be able to revert this!",
                                    icon: 'warning',
                                    showCancelButton: true,
                                    confirmButtonColor: '#3085d6',
                                    cancelButtonColor: '#d33',
                                    confirmButtonText: 'Yes, delete it!'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = button.href
                                    }

                                })
                            })
                        })
                    })








                </script>
                <%- include ('../partials/userFooter') %>
                    <%- include ('../layouts/footer') %>